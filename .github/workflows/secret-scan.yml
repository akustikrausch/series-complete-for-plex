name: Secret Scanner

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  secret-scan:
    runs-on: ubuntu-latest
    name: Scan for secrets
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Custom secret patterns check
        run: |
          echo "Scanning for project-specific secrets..."
          FOUND=0

          # Known project keys
          if grep -rn "e02cd2ade344678df60600a3a7d69860" --include='*.js' --include='*.json' --include='*.html' . 2>/dev/null | grep -v '.env.example' | grep -v 'config.json'; then
            echo "::error::Found TMDb API key in source files!"
            FOUND=1
          fi

          if grep -rn "af6ca8d3-3ddc-4e1d-8f30-3ad46c8f6e50" --include='*.js' --include='*.json' --include='*.html' . 2>/dev/null | grep -v '.env.example'; then
            echo "::error::Found TheTVDB API key in source files!"
            FOUND=1
          fi

          if grep -rn "sk-proj-" --include='*.js' --include='*.json' --include='*.html' . 2>/dev/null | grep -v '.env.example'; then
            echo "::error::Found OpenAI API key in source files!"
            FOUND=1
          fi

          if grep -rn "4de86c97" --include='*.js' --include='*.json' . 2>/dev/null | grep -v '.env.example'; then
            echo "::error::Found OMDb API key in source files!"
            FOUND=1
          fi

          if grep -rn "DEMO_KEY" --include='*.js' . 2>/dev/null; then
            echo "::error::Found DEMO_KEY placeholder in source files!"
            FOUND=1
          fi

          # Personal data
          if grep -rn "/mnt/c/Users/andre\|/Users/andre\|C:\\\\Users\\\\andre" --include='*.js' --include='*.json' --include='*.html' . 2>/dev/null; then
            echo "::error::Found personal path in source files!"
            FOUND=1
          fi

          # Private files that should not exist
          for f in .env config.local.json CLAUDE.md SYNC-PLAN.md sync-to-public.sh analysis-cache.json; do
            if [ -f "$f" ]; then
              echo "::error::Private file '$f' found in repo!"
              FOUND=1
            fi
          done

          if [ "$FOUND" -eq 1 ]; then
            echo "::error::Secret scan FAILED!"
            exit 1
          fi

          echo "All secret checks passed."
